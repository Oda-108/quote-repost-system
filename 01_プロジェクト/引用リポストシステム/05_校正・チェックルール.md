# 校正・チェックルール

引用リポスト案の品質を自動チェックするルール定義。
Lambda関数 `qr-generate` 内で校正→アルゴリズムチェック→トレンドKWチェックの順に実行。

---

## ② 校正エンジン

Style_Guidelinesに基づく文体チェック。AI生成後にプログラムで自動判定。

### チェック項目

| 項目 | 基準 | 処理 | 実装方法 |
|------|------|------|---------|
| 禁止ワード | `forbidden_words` リスト | ⚠️ 警告+代替提案 | 文字列マッチ |
| 語尾 | 関西弁禁止、体言止め推奨 | ✅ 自動修正 | 正規表現 |
| 一人称/二人称 | 俺・自分・お前・お前さん・あなた・君 | ✅ 自動修正 | 正規表現 |
| 文字数 | 通常140-280 / 長文1,000-1,500 | ⚠️ 警告 | len() |
| 改行の自然さ | 呼吸のリズム | AI再判定 | Claude API |
| Markdown記法 | `**` `#` `- ` 等の禁止 | ✅ 自動削除 | 正規表現 |
| 絵文字 | 原則禁止 | ✅ 自動削除 | Unicode範囲 |
| 元ポストコピー | 元ポストとの類似度20%以下 | ⚠️ 警告 | 編集距離 |

### 禁止ワードリスト（デフォルト: 織田設定）

```python
FORBIDDEN_WORDS = [
    "無理", "諦める", "できない", "設計",
    "頑張れ",  # 単独使用時のみ
    "教えてくれ",
    "静かなる",
    "会社員やってる奴、大体ない",
    "これ、マジで本質や",
    "市場と対話して",
    "コレ、",
]

# 関西弁語尾パターン
KANSAI_PATTERNS = [
    r"やん[。！？\s]*$",
    r"なる[。！？\s]*$",
    r"[^し]や[。！？\s]*$",  # 「〜や。」
    r"もうた[。！？\s]*$",
]
```

### 自動修正ルール

```python
CORRECTIONS = {
    # 語尾の修正
    r"やん$": "",         # 削除してAI再生成トリガー
    r"もうた$": "しまった",
    
    # Markdown削除
    r"\*\*(.+?)\*\*": r"\1",
    r"^#+\s": "",
    r"^-\s": "",
    
    # 絵文字削除（Unicode範囲）
    r"[\U0001F600-\U0001F64F]": "",
    r"[\U0001F300-\U0001F5FF]": "",
    r"[\U0001F680-\U0001F6FF]": "",
    r"[\U0001F1E0-\U0001F1FF]": "",
}
```

---

## ③ アルゴリズムチェック（万バズ方程式 v2）

### スコアリング（100点満点）

| 項目 | 配点 | チェック方法 | 自動判定 |
|------|------|------------|---------|
| フック強度 | 15 | 1行目が感情を動かすか | AI判定 |
| 構成パターン | 15 | 7パターンに合致するか | AI判定 |
| 感情設計 | 10 | ネガ→ポジ or ポジ→超ポジ | AI判定 |
| 具体性 | 10 | 数字/金額/人数の含有 | 正規表現 |
| ブックマーク誘発 | 10 | 保存したくなる要素 | AI判定 |
| 文字数 | 5 | 最適レンジ内か | len() |
| 読後の感情体験 | 5 | 読んでて気持ちいいか | AI判定 |
| テーマ旬度 | 10 | リアルタイム性 | AI判定 |
| ブランド一貫性 | 10 | 思想軸と整合 | AI判定 |
| 自然誘発型CTA | 10 | 自然に行動したくなるか | AI判定 |
| **合計** | **100** | — | — |

### 判定基準

| スコア | 判定 | アクション |
|--------|------|----------|
| 80点以上 | GO | Discord通知へ進む |
| 60〜79点 | 要修正 | AI再生成（修正箇所を明示） |
| 60点未満 | リジェクト | 案を破棄、ログに記録 |

### 具体性チェック（自動判定ロジック）

```python
import re

def check_specificity(text):
    """数字・金額・人数の含有をチェック"""
    score = 0
    
    # 数字の存在
    if re.search(r'\d+', text):
        score += 3
    
    # 金額表現
    if re.search(r'[\d,]+万|[\d,]+円|[\d,]+億|月収[\d,]+', text):
        score += 4
    
    # 人数・期間
    if re.search(r'\d+人|\d+ヶ月|\d+日|\d+年|\d+時間', text):
        score += 3
    
    return min(score, 10)  # 最大10点
```

---

## トレンドキーワードチェック

### チェック方法

```python
def check_trend_keywords(text, trend_keywords):
    """トレンドKWが自然に含まれているかチェック"""
    used_keywords = []
    for kw in trend_keywords:
        if kw in text:
            used_keywords.append(kw)
    
    return {
        "has_trend_kw": len(used_keywords) > 0,
        "used_keywords": used_keywords,
        "count": len(used_keywords)
    }
```

### トレンドKW収集（週次Lambda）

ベンチマーク15アカウントの直近1週間のポストから頻出ワードを抽出:

1. X API v2で各アカウントの直近ポスト取得
2. 形態素解析（MeCab or SudachiPy）で名詞・動詞を抽出
3. 助詞・接続詞・一般的すぎる語を除外
4. 出現頻度TOP50をDynamoDBに保存
5. 前週との差分で「新規トレンド」を識別

---

## チェック処理の全体フロー

```
AI生成（3案）
    ↓
[校正エンジン]
  ├─ 禁止ワード？ → 警告付きで通過 or 自動修正
  ├─ 語尾OK？ → 自動修正
  ├─ 文字数OK？ → 警告
  ├─ Markdown/絵文字？ → 自動削除
  └─ 改行自然？ → AI再判定（不自然なら修正依頼）
    ↓
[アルゴリズムチェック]
  ├─ 各項目スコア算出
  ├─ 具体性: 正規表現で自動判定
  └─ その他: AI判定（Claude APIで2回目のコール）
    ↓
[トレンドKWチェック]
  └─ 含有: ✅/❌（含まれてなくても通過、スコアに影響しない）
    ↓
[判定]
  ├─ 80点以上 → Discord通知へ
  ├─ 60〜79点 → 修正箇所を明示してAI再生成（最大2回リトライ）
  └─ 60点未満 → 破棄 + ログ記録
```
